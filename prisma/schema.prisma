// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model User {
  id        String     @id @default(cuid())
  email     String     @unique
  name      String?
  password  String?
  avatar    String?    // URL to avatar image
  bio       String?
  language  String     @default("en")
  theme     String     @default("auto") // light, dark, auto
  preferences Json?    // Notification settings, editor preferences, etc.
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt

  workspaces     WorkspaceMember[]
  providerKeys   UserProviderKey[]
  sessions       Session[]
  contentSources ContentSource[]
  activityLogs   ActivityLog[]
  notifications  Notification[]

  @@index([email])
}

model Session {
  id        String     @id @default(cuid())
  userId    String
  user      User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  token     String     @unique
  expiresAt DateTime
  createdAt DateTime   @default(now())

  @@index([userId])
  @@index([token])
}

model Workspace {
  id        String     @id @default(cuid())
  name      String
  icon      String?    // Emoji or icon URL
  color     String?    // Workspace theme color
  visibility String    @default("private") // "private" | "public"
  settings  Json?      // Additional workspace settings
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt

  members        WorkspaceMember[]
  mindMaps       MindMap[]
  templates      Template[]
  contentSources ContentSource[]
  activityLogs   ActivityLog[]

  @@index([createdAt])
}

model WorkspaceMember {
  id          String   @id @default(cuid())
  userId      String
  workspaceId String
  role        String   @default("member") // "owner" | "member"

  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  workspace Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  @@unique([userId, workspaceId])
  @@index([workspaceId])
}

model MindMap {
  id            String    @id @default(cuid())
  title         String
  description   String?
  summary       String?   // Generated AI summary of the entire map
  prompt        String?   // Original prompt used for generation
  provider      String?   // Which AI provider was used
  complexity    String?   // simple, moderate, complex
  layout        String?   // hierarchical, radial, etc.
  style         Json?     // Global style settings for this map
  settings      Json?     // Generation/Editor settings
  workspaceId   String
  embeddings    Json?     // Vector embeddings for AI assistant
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  workspace     Workspace  @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  nodes         MapNode[]
  generationJobs GenerationJob[]
  shareLinks    ShareLink[]
  activityLogs  ActivityLog[]

  @@index([workspaceId])
  @@index([createdAt])
}

model MapNode {
  id          String    @id @default(cuid())
  mindMapId   String
  title       String?
  content     String    // Rich text content, summary, or expanded details
  parentId    String?
  children    MapNode[] @relation("NodeChildren")
  x           Float     @default(0)
  y           Float     @default(0)
  width       Float     @default(200)
  height      Float     @default(100)
  color       String?   // Hex color for node styling
  shape       String    @default("rectangle") // rectangle, circle, diamond, etc.
  style       Json?     // Advanced styling overrides
  level       Int       @default(0) // Depth in hierarchy
  order       Int       @default(0) // Order among siblings
  isCollapsed Boolean   @default(false)
  embeddings  Json?     // Vector embeddings for AI assistant
  lockedBy    String?   // User ID who has locked this node for editing
  lockedAt    DateTime? // When the node was locked
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  mindMap     MindMap               @relation(fields: [mindMapId], references: [id], onDelete: Cascade)
  parent      MapNode?              @relation("NodeChildren", fields: [parentId], references: [id], onDelete: Cascade)
  attachments ContentAttachment[]
  citations   NodeCitation[]
  generationJobs GenerationJob[]

  @@index([mindMapId])
  @@index([parentId])
  @@index([level])
  @@index([lockedBy])
}

model NodeCitation {
  id        String   @id @default(cuid())
  nodeId    String
  title     String
  url       String?
  summary   String?
  author    String?
  createdAt DateTime @default(now())

  node MapNode @relation(fields: [nodeId], references: [id], onDelete: Cascade)

  @@index([nodeId])
}

model GenerationJob {
  id          String     @id @default(cuid())
  mindMapId   String?
  nodeId      String?
  prompt      String
  provider    String     // openai, gemini, anthropic
  status      String     // pending, processing, completed, failed
  result      Json?      // Generated content tree
  error       String?
  tokensUsed  Int        @default(0)
  startedAt   DateTime?
  completedAt DateTime?
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt

  mindMap     MindMap?   @relation(fields: [mindMapId], references: [id], onDelete: Cascade)
  node        MapNode?   @relation(fields: [nodeId], references: [id], onDelete: Cascade)

  @@index([status])
  @@index([createdAt])
  @@index([mindMapId])
  @@index([nodeId])
}

// Add a constraint to ensure a GenerationJob has either a mindMapId or nodeId, but not both
// This is enforced in application logic rather than database constraints

model ContentAttachment {
  id       String   @id @default(cuid())
  nodeId   String
  type     String   // "image" | "link" | "note"
  url      String?
  content  String?
  metadata Json?
  createdAt DateTime @default(now())

  node MapNode @relation(fields: [nodeId], references: [id], onDelete: Cascade)

  @@index([nodeId])
}

model Template {
  id          String   @id @default(cuid())
  name        String
  description String?
  content     Json
  workspaceId String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  workspace Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  @@index([workspaceId])
}

model UserProviderKey {
  id          String   @id @default(cuid())
  userId      String
  provider    String   // "openai" | "anthropic" | "google"
  label       String?
  encryptedKey String
  isDefault   Boolean  @default(false)
  usage       Json?    // Track usage stats
  lastUsedAt  DateTime?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model ContentSource {
  id               String   @id @default(cuid())
  workspaceId      String
  userId           String
  sourceType       String   // "text" | "youtube" | "pdf" | "web" | "websearch"
  status           String   // "pending" | "processing" | "completed" | "failed"
  rawPayload       Json     // Original input data
  processedContent Json?    // Normalized chunks with metadata
  metadata         Json?    // Title, URL, timestamps, author, etc.
  error            String?  // Error message for failed ingestions
  embeddings       Json?    // Vector embeddings (optional for now)
  citations        Json?    // Source attribution
  contentHash      String?  // For deduplication
  sizeBytes        Int      @default(0)
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  workspace Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([workspaceId])
  @@index([userId])
  @@index([status])
  @@index([sourceType])
  @@index([contentHash])
  @@index([createdAt])
}

model ShareLink {
  id          String    @id @default(cuid())
  mindMapId   String
  token       String    @unique // Unique shareable token
  role        String    // "owner" | "editor" | "viewer"
  password    String?   // Optional password (hashed)
  expiresAt   DateTime? // Optional expiry date
  createdBy   String    // User ID who created the link
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  mindMap MindMap @relation(fields: [mindMapId], references: [id], onDelete: Cascade)

  @@index([mindMapId])
  @@index([token])
  @@index([expiresAt])
}

model UserPresence {
  id          String   @id @default(cuid())
  userId      String
  mindMapId   String
  userName    String   // Cached user name for display
  cursorX     Float?   // Current cursor position
  cursorY     Float?
  color       String   // User's presence color
  lastSeenAt  DateTime @default(now())
  createdAt   DateTime @default(now())

  @@unique([userId, mindMapId])
  @@index([mindMapId])
  @@index([lastSeenAt])
}

model MapTemplate {
  id          String   @id @default(cuid())
  name        String
  description String?
  category    String   // "project", "study", "timeline", "brainstorm", etc.
  prompt      String   // Prompt template
  language    String   @default("en") // Language code
  complexity  String   @default("moderate")
  isPublic    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([category])
  @@index([language])
  @@index([isPublic])
}

model ActivityLog {
  id          String   @id @default(cuid())
  userId      String
  workspaceId String?
  mindMapId   String?
  action      String   // create, edit, delete, comment, share
  details     Json?
  createdAt   DateTime @default(now())

  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  workspace   Workspace? @relation(fields: [workspaceId], references: [id], onDelete: SetNull)
  mindMap     MindMap?  @relation(fields: [mindMapId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([workspaceId])
  @@index([createdAt])
}

model Notification {
  id          String   @id @default(cuid())
  userId      String
  type        String   // email, in-app
  message     String
  read        Boolean  @default(false)
  createdAt   DateTime @default(now())

  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([read])
}
